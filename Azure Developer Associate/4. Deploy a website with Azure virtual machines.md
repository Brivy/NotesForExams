# Deploy a website with Azure virtual machines

This is the fourth chapter of the online Azure Developer Associate course.

## Introduction to Azure virtual machines

Azure VMs are one of several types of on-demand, scalable computing resources that Azure offers. With VMs, you have total control over the configuration and can install anything you need to perform the work. You don't need to purchase physical hardware when you need to scale or extend your datacenter. Finally, Azure provides additional services to monitor, secure, and manage updates and patches to the OS.

## A VM checklist

There are several things that need to be considered when you want to move/migrate to a VM:

**Networking**. By setting up Virtual Networks (VNets), you can connect privately between your azure resources. External networks aren't allowed at default but can be enabled. You should think about this resource first because you can't just change it.

When setting this all up, you need to specify the available *address spaces*, *subnets* and *security*. If the VNet will be connected to other VNets, you must select address ranges that are not overlapping.

After deciding the virtual network address space(s), you can create one or more subnets for your virtual network (like 10.1.0.0 to VMs, 10.2.0.0 to back-end services, ect.).

While there is no default security boundary between subnets, you can set up Network Security Groups (NSGs) to control traffic flow to and from subnets/VMs. They act like firewalls, applying custom rules to each inbound or outbound request at the network interface and subnet level.

**Plan the VM deployment**.

Before creating the VM, there are a couple of things to add into consideration:

- The **name** of the VM. Can be up to 15 characters on Windows and 64 on Linux. Also defines a manageable Azure resource that can't be changed (easily) later. An example is `devusc-webvm01`. Think of the following subjects when choosing the name:
  - Environment: dev, prod, QA
  - Location: uw, ue, we
  - Instance: 01, 02
  - Product or Service: service
  - Role: sql, web, messaging
- The **location** is also important. There are two major things to consider:
  - Hardware availability.
  - Price differences.
- The **size** can also differ from what you want. You can change the size later, even when the VM is running (but this will restart the VM and can change some options). But only when your VM is deallocated, you can select all the sizes in your region, otherwise it is only the sizes in your current hardware cluster.

  There are a few sets of workloads to choice from, all with their own options:
  - *General purpose*: Designed to have a balanced CPU-to-memory ratio. Ideal for testing and development, small to medium databases, and low to medium traffic web servers.
  - *Compute optimized*: Designed to have a high CPU-to-memory ratio. Suitable for medium traffic web servers, network appliances, batch processes, and application servers.
  - *Memory optimized*: Designed to have a high memory-to-CPU ratio. Great for relational database servers, medium to large caches, and in-memory analytics.
  - *Storage optimized*: Designed to have high disk throughput and IO. Ideal for VMs running databases.
  - *GPU*: Specialized virtual machines targeted for heavy graphics rendering and video editing. These VMs are ideal options for model training and inferencing with deep learning.
  - *High performance computes*: The fastest and most powerful CPU virtual machines with optional high-throughput network interfaces.

For pricing, there are two separated costs:

- **Compute costs**: Priced on a per-hour basis but billed on a per-minute basis. For example, you are only charged for 55 minutes of usage if the VM is deployed for 55 minutes. You are not charged for compute capacity if you stop and deallocate the VM since this releases the hardware. Reusing existing licenses for Windows with the Azure Hybrid benefit can save you some costs.
- **Storage costs**: Priced for using storage. Even when the VM is deallocated, you still get charged for this.

You can pay for the compute costs by:

- **Pay as you go**: You pay for compute capacity by the second, with no long-term commitment or upfront payments. You're able to increase or decrease compute capacity on demand as well as start or stop at any time.
- **Reserved Virtual Machine Instances**: An advance purchase of a virtual machine for one or three years in a specified region. The commitment is made up front, and in return, you get up to 72% price savings compared to pay-as-you-go pricing. RIs are flexible and can easily be exchanged or returned for an early termination fee.

Azure VMs have at least two virtual hard disks (VHDs), one for the OS and one for temporary storage. It's possible to add new disks but it can be limited (two per CPU). The data of these disks is held in Azure Storage as *page blobs* which allows Azure to allocate space only for the storage you use.
Virtual disks can be either *Standard* or *Premium*, depending on what you need. The big difference is that Premium uses SSDs.

For disks, you also need to choose either:

- **Unmanaged disks**: You are responsible for the storage accounts that are used to hold the VHDs that correspond to your VM disks. You pay the storage account rates for the amount of space you use. A single storage account has a fixed-rate limit of 20,000 I/O operations/sec. This means that a storage account is capable of supporting 40 standard virtual hard disks at full utilization. If you need to scale out with more disks, then you'll need more storage accounts, which can get complicated.
- **Managed disks**: Managed disks are the newer and recommended disk storage model. They elegantly solve this complexity by putting the burden of managing the storage accounts onto Azure. You specify the size of the disk, up to 4 TB per disk, and Azure creates and manages both the disk and the storage. You don't have to worry about storage account limits, which makes managed disks easier to scale out.

Oh and don't forget the OS itself. You can select some from the marketplace if the default ones aren't enough. Also Azure supports only 64-bit operating systems.
